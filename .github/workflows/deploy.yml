name: Deploy to Mikrus

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install packages
        run: |
          npm install --force

      - name: Build backend (NestJS)
        run: |
          npx nx build chronoco-api

      - name: Build frontend (Angular)
        run: |
          npx nx build Chronoco

      - name: Deploy frontend
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.MIKRUS_HOST }}
          username: ${{ secrets.MIKRUS_USER }}
          key: ${{ secrets.MIKRUS_SSH_KEY }}
          port: ${{ secrets.MIKRUS_PORT }}
          source: "dist/apps/Chronoco"
          target: "/home/deploy/apps/chronoco-github-actions"

      - name: Restart PM2 on Mikrus
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MIKRUS_HOST }}
          username: ${{ secrets.MIKRUS_USER }}
          key: ${{ secrets.MIKRUS_SSH_KEY }}
          port: ${{ secrets.MIKRUS_PORT }}
          script: |
            cd /home/deploy/apps/chronoco-github-actions/dist/apps/Chronoco/server
            echo "Restarting PM2 process..."
            pm2 delete CHRONOCO_ANGULAR
            pm2 start "node server.mjs" --name CHRONOCO_ANGULAR

      - name: Deploy API
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.MIKRUS_HOST }}
          username: ${{ secrets.MIKRUS_USER }}
          key: ${{ secrets.MIKRUS_SSH_KEY }}
          port: ${{ secrets.MIKRUS_PORT }}
          source: "dist/chronoco-api/*"
          target: "/home/deploy/apps/chronoco-backend"

      - name: Install backend dependencies on Mikrus
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MIKRUS_HOST }}
          username: ${{ secrets.MIKRUS_USER }}
          key: ${{ secrets.MIKRUS_SSH_KEY }}
          port: ${{ secrets.MIKRUS_PORT }}
          script: |
            cd /home/deploy/apps/chronoco-backend/dist/chronoco-api
            echo "Running npm install..."
            npm install --force

      - name: Create .env on Mikrus
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MIKRUS_HOST }}
          username: ${{ secrets.MIKRUS_USER }}
          key: ${{ secrets.MIKRUS_SSH_KEY }}
          port: ${{ secrets.MIKRUS_PORT }}
          script: |
            cd /home/deploy/apps/chronoco-backend/dist/chronoco-api
            echo "DB_HOST=${{ secrets.DB_HOST }}" > .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "HTTPS_COOKIES_SECURE=${{ secrets.HTTPS_COOKIES_SECURE }}" >> .env

      - name: Restart PM2 for API on Mikrus
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MIKRUS_HOST }}
          username: ${{ secrets.MIKRUS_USER }}
          key: ${{ secrets.MIKRUS_SSH_KEY }}
          port: ${{ secrets.MIKRUS_PORT }}
          script: |
            cd /home/deploy/apps/chronoco-backend/dist/chronoco-api
            echo "Restarting PM2 process..."
            pm2 delete CHRONOCO_API
            pm2 start main.js --name CHRONOCO_API
